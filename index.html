<!DOCTYPE html>
<!-- 
  DEUIL NATIONAL : Pour activer le mode "en berne" (drapeau en noir et blanc),
  ajouter l'attribut data-fr-mourning sur la balise html ci-dessous :
  <html lang="fr" data-fr-scheme="system" data-fr-mourning>
-->
<html lang="fr" data-fr-scheme="system">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="format-detection" content="telephone=no,date=no,address=no,email=no,url=no">
  <meta name="theme-color" content="#000091">
  
  <!-- Script bloquant pour mode sombre - évite le flash blanc -->
  <script>
    (function() {
      var scheme = localStorage.getItem('scheme');
      var htmlScheme = document.documentElement.getAttribute('data-fr-scheme');
      var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      if (scheme === 'dark' || (scheme === 'system' && prefersDark) || 
          (htmlScheme === 'system' && prefersDark) || htmlScheme === 'dark') {
        document.documentElement.setAttribute('data-fr-theme', 'dark');
        document.documentElement.style.colorScheme = 'dark';
      }
    })();
  </script>
  
  <title>Tableau de bord SPE - Mesure 10</title>
  
  <!-- Favicons DSFR officiels -->
  <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.3/dist/favicon/apple-touch-icon.png">
  <link rel="icon" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.3/dist/favicon/favicon.svg" type="image/svg+xml">
  <link rel="shortcut icon" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.3/dist/favicon/favicon.ico" type="image/x-icon">
  
  <!-- DSFR CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.3/dist/dsfr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.3/dist/utility/utility.min.css">
  
  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    /* ============================================
       STYLES CUSTOM CONFORMES DSFR
       Utilisation des variables CSS DSFR uniquement
       ============================================ */
    
    /* Spinner de chargement */
    .spe-spinner {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 3px solid var(--border-default-grey);
      border-top-color: var(--text-action-high-blue-france);
      border-radius: 50%;
      animation: spe-spin 1s linear infinite;
    }
    @keyframes spe-spin {
      to { transform: rotate(360deg); }
    }
    
    /* Indicateurs KPI - Structure uniforme */
    .spe-stat-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-4v);
    }
    
    .spe-stat-item {
      padding: var(--spacing-4v);
      background-color: var(--background-default-grey);
      text-align: center;
      min-height: 140px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
    }
    
    .spe-stat-item--main {
      min-height: 160px;
    }
    
    .spe-stat-item--alt {
      background-color: var(--background-alt-grey);
    }
    
    .spe-stat-item--contrast {
      background-color: var(--background-contrast-grey);
    }
    
    .spe-stat-item--raised {
      background-color: var(--background-raised-grey);
      box-shadow: var(--raised-shadow);
    }
    
    .spe-stat-item--accent {
      background-color: var(--background-action-high-blue-france);
      color: var(--text-inverted-grey);
    }
    
    .spe-stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      line-height: 1.2;
      margin: var(--spacing-2v) 0;
    }
    
    .spe-stat-value--success {
      color: var(--text-default-success);
    }
    
    .spe-stat-value--warning {
      color: var(--text-default-warning);
    }
    
    .spe-stat-value--error {
      color: var(--text-default-error);
    }
    
    .spe-stat-label {
      font-size: 0.875rem;
      color: var(--text-mention-grey);
    }
    
    .spe-stat-detail {
      font-size: 0.75rem;
      color: var(--text-mention-grey);
      margin-top: var(--spacing-1v);
    }
    
    /* Barre de progression EGalim style ma-cantine */
    .egalim-bar-container {
      position: relative;
      margin: 2rem 0 1rem 0;
    }
    
    .egalim-bar-objectives {
      position: relative;
      height: 3rem;
      margin-bottom: 0.5rem;
    }
    
    .egalim-bar-objective {
      position: absolute;
      top: 0;
      transform: translateX(-50%);
      text-align: center;
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .egalim-bar-objective::after {
      content: '';
      position: absolute;
      left: 50%;
      top: 1.5rem;
      width: 2px;
      height: calc(3rem + 8px);
      border-left: 2px dashed #18753c;
    }
    
    .egalim-bar {
      position: relative;
      height: 2.5rem;
      background-color: #e8edff;
      border: 2px solid #18753c;
      border-radius: 4px;
      overflow: visible;
      display: flex;
    }
    
    .egalim-bar-bio {
      height: 100%;
      background: repeating-linear-gradient(
        90deg,
        #18753c,
        #18753c 8px,
        #a3e2b8 8px,
        #a3e2b8 16px
      );
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.875rem;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      min-width: fit-content;
      padding: 0 0.5rem;
    }
    
    .egalim-bar-qualite {
      height: 100%;
      background-color: #18753c;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 0.875rem;
      min-width: fit-content;
      padding: 0 0.5rem;
    }
    
    .egalim-bar-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      margin-top: 1rem;
      font-size: 0.875rem;
    }
    
    .egalim-bar-legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .egalim-bar-legend-color {
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 2px;
      flex-shrink: 0;
    }
    
    .egalim-bar-legend-color--bio {
      background: repeating-linear-gradient(
        90deg,
        #18753c,
        #18753c 4px,
        #a3e2b8 4px,
        #a3e2b8 8px
      );
    }
    
    .egalim-bar-legend-color--qualite {
      background-color: #18753c;
    }
    
    .egalim-bar-legend-color--objectif {
      width: 2px;
      height: 1.25rem;
      border-left: 2px dashed #18753c;
      background: transparent;
    }
    
    /* Mode sombre - barre EGalim */
    [data-fr-theme="dark"] .egalim-bar,
    [data-fr-scheme="dark"] .egalim-bar {
      background-color: #1e3a5f;
      border-color: #34d399;
    }
    
    [data-fr-theme="dark"] .egalim-bar-bio,
    [data-fr-scheme="dark"] .egalim-bar-bio {
      background: repeating-linear-gradient(
        90deg,
        #059669,
        #059669 8px,
        #065f46 8px,
        #065f46 16px
      );
    }
    
    [data-fr-theme="dark"] .egalim-bar-qualite,
    [data-fr-scheme="dark"] .egalim-bar-qualite {
      background-color: #059669;
    }
    
    [data-fr-theme="dark"] .egalim-bar-objective::after,
    [data-fr-scheme="dark"] .egalim-bar-objective::after {
      border-left-color: #34d399;
    }
    
    /* Tableau - Lignes colorées selon statut (couleurs lisibles) */
    .spe-row-error {
      background-color: #fecaca !important; /* Rouge clair pour fond lisible */
    }
    
    .spe-row-warning {
      background-color: #fef3c7 !important; /* Jaune clair */
    }
    
    .spe-row-success {
      background-color: #d1fae5 !important; /* Vert clair */
    }
    
    .spe-row-excluded {
      background-color: var(--background-contrast-grey) !important;
      color: var(--text-inverted-grey) !important;
    }
    
    /* Texte d'erreur visible sur fond clair */
    .spe-text-error {
      color: #b91c1c !important; /* Rouge foncé lisible */
      font-weight: 500;
    }
    
    /* Graphiques custom (hors périmètre DSFR) */
    .spe-chart-container {
      padding: var(--spacing-4v);
      background-color: var(--background-default-grey);
    }
    
    .spe-chart-title {
      font-weight: 700;
      margin-bottom: var(--spacing-3v);
      text-align: center;
    }
    
    .spe-chart-wrapper {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-4v);
      flex-wrap: wrap;
    }
    
    .spe-chart-legend {
      flex: 1;
      min-width: 150px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.8125rem;
    }
    
    .spe-chart-legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: var(--spacing-1v);
    }
    
    .spe-chart-legend-color {
      width: 12px;
      height: 12px;
      flex-shrink: 0;
      margin-right: 0.25rem;
    }
    
    /* Utilitaires */
    .spe-text-mono {
      font-family: monospace;
      font-size: 0.75rem;
    }
    
    .spe-word-break {
      word-wrap: break-word;
      white-space: normal;
    }
    
    /* Badge dans le titre du header */
    .fr-header__service-title .fr-badge {
      vertical-align: middle;
      margin-left: 0.5rem;
    }
    
    /* Mode sombre - adaptation des couleurs */
    /* Utilise data-fr-theme qui est l'attribut défini par le script DSFR */
    [data-fr-theme="dark"] .spe-row-error,
    [data-fr-scheme="dark"] .spe-row-error {
      background-color: #450a0a !important; /* Rouge très foncé */
      color: #fecaca !important; /* Texte rose clair */
    }
    
    [data-fr-theme="dark"] .spe-row-error td,
    [data-fr-scheme="dark"] .spe-row-error td {
      color: #fecaca !important;
    }
    
    [data-fr-theme="dark"] .spe-row-warning,
    [data-fr-scheme="dark"] .spe-row-warning {
      background-color: #451a03 !important; /* Ambre très foncé */
      color: #fef3c7 !important; /* Texte jaune clair */
    }
    
    [data-fr-theme="dark"] .spe-row-warning td,
    [data-fr-scheme="dark"] .spe-row-warning td {
      color: #fef3c7 !important;
    }
    
    [data-fr-theme="dark"] .spe-row-success,
    [data-fr-scheme="dark"] .spe-row-success {
      background-color: #022c22 !important; /* Vert très foncé */
      color: #d1fae5 !important; /* Texte vert clair */
    }
    
    [data-fr-theme="dark"] .spe-row-success td,
    [data-fr-scheme="dark"] .spe-row-success td {
      color: #d1fae5 !important;
    }
    
    [data-fr-theme="dark"] .spe-text-error,
    [data-fr-scheme="dark"] .spe-text-error {
      color: #fca5a5 !important; /* Rouge clair lisible sur fond sombre */
    }
    
    [data-fr-theme="dark"] .spe-chart-container,
    [data-fr-scheme="dark"] .spe-chart-container {
      background-color: var(--background-alt-grey);
    }
    
    /* Assurer que les icônes restent visibles en mode sombre */
    [data-fr-theme="dark"] .spe-row-error .fr-icon-warning-fill,
    [data-fr-scheme="dark"] .spe-row-error .fr-icon-warning-fill {
      color: #fca5a5 !important;
    }
    
    [data-fr-theme="dark"] .spe-row-success .fr-icon-checkbox-circle-fill,
    [data-fr-scheme="dark"] .spe-row-success .fr-icon-checkbox-circle-fill {
      color: #6ee7b7 !important;
    }
    
    /* Échantillons de couleur pour la légende */
    .spe-legend-color {
      display: inline-block;
      padding: 0 0.5rem;
      border-radius: 2px;
      font-weight: 500;
    }
    
    .spe-legend-color--error {
      background-color: #fecaca;
      color: #1f2937;
    }
    
    .spe-legend-color--warning {
      background-color: #fef3c7;
      color: #1f2937;
    }
    
    .spe-legend-color--success {
      background-color: #d1fae5;
      color: #1f2937;
    }
    
    /* Mode sombre - échantillons de couleur légende (identiques au tableau) */
    [data-fr-theme="dark"] .spe-legend-color--error,
    [data-fr-scheme="dark"] .spe-legend-color--error {
      background-color: #450a0a;
      color: #fecaca;
    }
    
    [data-fr-theme="dark"] .spe-legend-color--warning,
    [data-fr-scheme="dark"] .spe-legend-color--warning {
      background-color: #451a03;
      color: #fef3c7;
    }
    
    [data-fr-theme="dark"] .spe-legend-color--success,
    [data-fr-scheme="dark"] .spe-legend-color--success {
      background-color: #022c22;
      color: #d1fae5;
    }
  </style>
</head>
<body id="top">
  <!-- ============================================
       HEADER DSFR OFFICIEL
       ============================================ -->
  <header role="banner" class="fr-header">
    <div class="fr-header__body">
      <div class="fr-container">
        <div class="fr-header__body-row">
          <div class="fr-header__brand fr-enlarge-link">
            <div class="fr-header__brand-top">
              <div class="fr-header__logo">
                <p class="fr-logo">
                  République<br>Française
                </p>
              </div>
              <div class="fr-header__navbar">
                <button class="fr-btn--menu fr-btn" data-fr-opened="false" aria-controls="modal-menu" aria-haspopup="menu" id="button-menu" title="Menu">
                  Menu
                </button>
              </div>
            </div>
            <div class="fr-header__service">
              <a href="/" title="Accueil - Tableau de bord SPE">
                <p class="fr-header__service-title">
                  Tableau de bord SPE - Mesure 10 <span class="fr-badge fr-badge--sm fr-badge--green-emeraude">BETA</span>
                </p>
              </a>
              <p class="fr-header__service-tagline">Direction générale de l'alimentation (DGAL)</p>
            </div>
          </div>
          <div class="fr-header__tools">
            <div class="fr-header__tools-links">
              <ul class="fr-btns-group">
                <li>
                  <button class="fr-btn fr-icon-theme-fill" aria-controls="fr-theme-modal" data-fr-opened="false">
                    Paramètres d'affichage
                  </button>
                </li>
                <li>
                  <a class="fr-btn fr-icon-book-2-line" href="https://cosmose.developpement-durable.gouv.fr/plugins/ExplorerPlugin/jsp/action/redirectToExplorer.jsp?desktopUrl=jcms%2Fc_2005278%2Ffr%2Fservices-publics-ecoresponsables%3FexplorerCurrentCategory%3Dc_2001002%26explorerSort%3Dudate%26explorerSortDescending%3Dfalse%26portlet%3Dc_2005277%26types%3DALL&mobileUrl=plugins%2FExplorerPlugin%2Fsmartphone%2Fexplorer.jsp%3FexplorerCurrentCategory%3Dc_2001002%26isWorkspaceFiltered%3Dtrue%26portletId%3Dc_2005277%26workspaceId%3Dc_2003842" target="_blank" rel="noopener" title="Ressources SPE - nouvelle fenêtre">
                    Ressources
                  </a>
                </li>
                <li>
                  <a class="fr-btn fr-icon-mail-line" href="mailto:guillaume.defer@agriculture.gouv.fr?subject=Tableau%20de%20bord%20SPE%20-%20Contact">
                    Nous contacter
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Menu mobile -->
    <div class="fr-header__menu fr-modal" id="modal-menu" aria-labelledby="button-menu">
      <div class="fr-container">
        <button class="fr-btn--close fr-btn" aria-controls="modal-menu" title="Fermer">
          Fermer
        </button>
        <div class="fr-header__menu-links">
          <ul class="fr-btns-group">
            <li>
              <button class="fr-btn fr-icon-theme-fill" aria-controls="fr-theme-modal" data-fr-opened="false">
                Paramètres d'affichage
              </button>
            </li>
            <li>
              <a class="fr-btn fr-icon-book-2-line" href="https://cosmose.developpement-durable.gouv.fr/plugins/ExplorerPlugin/jsp/action/redirectToExplorer.jsp?desktopUrl=jcms%2Fc_2005278%2Ffr%2Fservices-publics-ecoresponsables%3FexplorerCurrentCategory%3Dc_2001002%26explorerSort%3Dudate%26explorerSortDescending%3Dfalse%26portlet%3Dc_2005277%26types%3DALL&mobileUrl=plugins%2FExplorerPlugin%2Fsmartphone%2Fexplorer.jsp%3FexplorerCurrentCategory%3Dc_2001002%26isWorkspaceFiltered%3Dtrue%26portletId%3Dc_2005277%26workspaceId%3Dc_2003842" target="_blank" rel="noopener" title="Ressources SPE - nouvelle fenêtre">
                Ressources
              </a>
            </li>
            <li>
              <a class="fr-btn fr-icon-mail-line" href="mailto:guillaume.defer@agriculture.gouv.fr?subject=Tableau%20de%20bord%20SPE%20-%20Contact">
                Nous contacter
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <!-- Modal Paramètres d'affichage DSFR -->
  <dialog id="fr-theme-modal" class="fr-modal" aria-labelledby="fr-theme-modal-title">
    <div class="fr-container fr-container--fluid fr-container-md">
      <div class="fr-grid-row fr-grid-row--center">
        <div class="fr-col-12 fr-col-md-6 fr-col-lg-4">
          <div class="fr-modal__body">
            <div class="fr-modal__header">
              <button class="fr-btn--close fr-btn" aria-controls="fr-theme-modal" title="Fermer">
                Fermer
              </button>
            </div>
            <div class="fr-modal__content">
              <h1 id="fr-theme-modal-title" class="fr-modal__title">Paramètres d'affichage</h1>
              <div id="fr-display" class="fr-display">
                <div class="fr-form-group">
                  <fieldset class="fr-fieldset">
                    <legend class="fr-fieldset__legend fr-text--regular" id="display-fieldset-legend">
                      Choisissez un thème pour personnaliser l'apparence du site.
                    </legend>
                    <div class="fr-fieldset__content">
                      <div class="fr-radio-group fr-radio-rich">
                        <input value="light" type="radio" id="fr-radios-theme-light" name="fr-radios-theme">
                        <label class="fr-label" for="fr-radios-theme-light">
                          Thème clair
                        </label>
                        <div class="fr-radio-rich__img">
                          <svg aria-hidden="true" class="fr-artwork" viewBox="0 0 80 80" width="80" height="80">
                            <use class="fr-artwork-decorative" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.3/dist/artwork/light.svg#artwork-light"></use>
                            <use class="fr-artwork-minor" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.3/dist/artwork/light.svg#artwork-minor"></use>
                            <use class="fr-artwork-major" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.3/dist/artwork/light.svg#artwork-major"></use>
                          </svg>
                        </div>
                      </div>
                      <div class="fr-radio-group fr-radio-rich">
                        <input value="dark" type="radio" id="fr-radios-theme-dark" name="fr-radios-theme">
                        <label class="fr-label" for="fr-radios-theme-dark">
                          Thème sombre
                        </label>
                        <div class="fr-radio-rich__img">
                          <svg aria-hidden="true" class="fr-artwork" viewBox="0 0 80 80" width="80" height="80">
                            <use class="fr-artwork-decorative" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.3/dist/artwork/dark.svg#artwork-dark"></use>
                            <use class="fr-artwork-minor" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.3/dist/artwork/dark.svg#artwork-minor"></use>
                            <use class="fr-artwork-major" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.3/dist/artwork/dark.svg#artwork-major"></use>
                          </svg>
                        </div>
                      </div>
                      <div class="fr-radio-group fr-radio-rich">
                        <input value="system" type="radio" id="fr-radios-theme-system" name="fr-radios-theme">
                        <label class="fr-label" for="fr-radios-theme-system">
                          Système
                          <span class="fr-hint-text">Utilise les paramètres système.</span>
                        </label>
                        <div class="fr-radio-rich__img">
                          <svg aria-hidden="true" class="fr-artwork" viewBox="0 0 80 80" width="80" height="80">
                            <use class="fr-artwork-decorative" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.3/dist/artwork/system.svg#artwork-system"></use>
                            <use class="fr-artwork-minor" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.3/dist/artwork/system.svg#artwork-minor"></use>
                            <use class="fr-artwork-major" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.3/dist/artwork/system.svg#artwork-major"></use>
                          </svg>
                        </div>
                      </div>
                    </div>
                  </fieldset>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </dialog>

  <!-- ============================================
       CONTENU PRINCIPAL - APPLICATION REACT
       ============================================ -->
  <main role="main" id="root"></main>

  <!-- ============================================
       RETOUR EN HAUT DE PAGE (DSFR)
       ============================================ -->
  <div class="fr-container fr-my-4w" style="text-align: center;">
    <a class="fr-link fr-icon-arrow-up-fill fr-link--icon-left" href="#top">
      Haut de page
    </a>
  </div>

  <!-- ============================================
       FOOTER DSFR OFFICIEL (conforme)
       ============================================ -->
  <footer class="fr-footer" role="contentinfo" id="footer">
    <div class="fr-container">
      <div class="fr-footer__body">
        <div class="fr-footer__brand fr-enlarge-link">
          <a href="/" title="Retour à l'accueil du site - Tableau de bord SPE">
            <p class="fr-logo">
              République<br>Française
            </p>
          </a>
        </div>
        <div class="fr-footer__content">
          <p class="fr-footer__content-desc">
            Outil proposé par la Direction générale de l'alimentation (DGAL) du Ministère de l'Agriculture, de l'Agro-alimentaire et de la Souveraineté alimentaire.
          </p>
          <ul class="fr-footer__content-list">
            <li class="fr-footer__content-item">
              <a class="fr-footer__content-link" target="_blank" rel="noopener external" href="https://info.gouv.fr" title="info.gouv.fr - nouvelle fenêtre">info.gouv.fr</a>
            </li>
            <li class="fr-footer__content-item">
              <a class="fr-footer__content-link" target="_blank" rel="noopener external" href="https://service-public.fr" title="service-public.fr - nouvelle fenêtre">service-public.fr</a>
            </li>
            <li class="fr-footer__content-item">
              <a class="fr-footer__content-link" target="_blank" rel="noopener external" href="https://legifrance.gouv.fr" title="legifrance.gouv.fr - nouvelle fenêtre">legifrance.gouv.fr</a>
            </li>
            <li class="fr-footer__content-item">
              <a class="fr-footer__content-link" target="_blank" rel="noopener external" href="https://data.gouv.fr" title="data.gouv.fr - nouvelle fenêtre">data.gouv.fr</a>
            </li>
          </ul>
        </div>
      </div>
      <div class="fr-footer__bottom">
        <ul class="fr-footer__bottom-list">
          <li class="fr-footer__bottom-item">
            <a class="fr-footer__bottom-link" href="/accessibilite">Accessibilité : non conforme</a>
          </li>
          <li class="fr-footer__bottom-item">
            <a class="fr-footer__bottom-link" href="/mentions-legales">Mentions légales</a>
          </li>
          <li class="fr-footer__bottom-item">
            <a class="fr-footer__bottom-link" href="/donnees-personnelles">Données personnelles</a>
          </li>
          <li class="fr-footer__bottom-item">
            <a class="fr-footer__bottom-link" href="/cookies">Gestion des cookies</a>
          </li>
          <li class="fr-footer__bottom-item">
            <a class="fr-footer__bottom-link" href="https://www.data.gouv.fr/fr/datasets/registre-national-des-cantines/" target="_blank" rel="noopener" title="Registre national des cantines - nouvelle fenêtre">Registre national des cantines</a>
          </li>
          <li class="fr-footer__bottom-item">
            <a class="fr-footer__bottom-link fr-icon-bug-line fr-link--icon-left" href="https://tally.so/r/3yagd4" target="_blank" rel="noopener" title="Signaler un bug - nouvelle fenêtre">Signaler un bug</a>
          </li>
        </ul>
        <div class="fr-footer__bottom-copy">
          <p>Sauf mention explicite de propriété intellectuelle détenue par des tiers, les contenus de ce site sont proposés sous <a href="https://github.com/etalab/licence-ouverte/blob/master/LO.md" target="_blank" rel="noopener" title="Licence etalab-2.0 - nouvelle fenêtre">licence etalab-2.0</a></p>
        </div>
      </div>
    </div>
  </footer>

  <!-- ============================================
       SCRIPTS DSFR
       ============================================ -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.3/dist/dsfr.module.min.js"></script>
  <script type="text/javascript" nomodule src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.14.3/dist/dsfr.nomodule.min.js"></script>

  <!-- ============================================
       APPLICATION REACT
       ============================================ -->
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // ==========================================
    // CONFIGURATION
    // ==========================================
    const API_PROXY = '/.netlify/functions/api-proxy';
    // Ressource CSV du Registre National des Cantines (mis à jour 09/01/2026)
    const DATAGOUV_RESOURCE_ID = '3f73d129-6b24-45cd-95e9-9bacc216d9d9';
    const DATAGOUV_DATASET_ID = '6482def590d4cf8cea3aa33e';

    // Liste des ministères (hardcodée pour fiabilité)
    const MINISTERES = [
      "Enseignement supérieur et Recherche",
      "Intérieur et Outre-mer",
      "Économie et finances",
      "Agriculture, Alimentation et Forêts",
      "Services du Premier Ministre",
      "Justice",
      "Sport",
      "Environnement",
      "Éducation et Jeunesse",
      "Affaires étrangères",
      "Travail",
      "Culture",
      "Fonction Publiques",
      "Santé et Solidarités",
      "Présidence de la république - Autorités indépendantes (AAI, API)",
      "Cohésion des territoires - Relations avec les collectivités territoriales",
      "Mer"
    ];

    // Liste des régions (hardcodée pour fiabilité)
    const REGIONS = [
      "Île-de-France",
      "Auvergne-Rhône-Alpes",
      "Nouvelle-Aquitaine",
      "Occitanie",
      "Provence-Alpes-Côte d'Azur",
      "Hauts-de-France",
      "Pays de la Loire",
      "Bretagne",
      "Bourgogne-Franche-Comté",
      "Grand Est",
      "Normandie",
      "Centre-Val de Loire",
      "La Réunion",
      "Corse",
      "Martinique",
      "Guadeloupe",
      "Guyane",
      "Mayotte"
    ];

    // Couleurs pour les graphiques (palette DSFR illustrative)
    const CHART_COLORS = [
      '#000091', // Bleu France
      '#6a6af4', // Bleu cumulé
      '#009081', // Vert menthe
      '#f95c5e', // Rouge marianne
      '#ff9940', // Orange terre battue
      '#a558a0', // Violet glycine
      '#417dc4', // Bleu cumulus
      '#66673d', // Vert bourgeon
    ];

    // Cibles RIA DGAFP par région
    const CIBLE_RIA_DGAFP = {
      "Auvergne-Rhône-Alpes": 12,
      "Bourgogne-Franche-Comté": 4,
      "Bretagne": 5,
      "Centre-Val de Loire": 6,
      "Corse": 1,
      "Grand Est": 12,
      "Hauts-de-France": 4,
      "Île-de-France": 7,
      "Normandie": 7,
      "Nouvelle-Aquitaine": 12,
      "Occitanie": 9,
      "Provence-Alpes-Côte d'Azur": 4,
      "Pays de la Loire": 10
    };

    // Règles de classification SPE
    const SPE_RULES = {
      operateurs_etat: ['INSEE', 'DGFIP', 'DGDDI', 'douane', 'DDFIP', 'DRFIP', 'DREAL', 'DRAAF', 'DDT', 'DDTM', 'DRAC', 'DIRECCTE', 'DREETS', 'DDETS', 'ARS', 'DGAC', 'aviation civile'],
      secteurs_etat: ['RIA', 'inter-administratif', 'administration', 'ministère', 'préfecture'],
      siret_prefixes_etat: ['11', '12', '13', '17', '18', '19'],
      codes_blanc: {
        prefixes: ['71', '73', '74'],
        exacts: ['4110', '4120', '4130', '4140', '4150', '4160', '8411', '8412', '8413']
      },
      codes_noir: {
        prefixes: ['1', '2', '3', '5', '6', '8', '9'],
        exacts: []
      }
    };

    // ==========================================
    // COMPOSANT GRAPHIQUE CAMEMBERT
    // ==========================================
    function PieChart({ data, title }) {
      const total = data.reduce((sum, item) => sum + item.value, 0);
      if (total === 0) return null;

      const size = 180;
      const radius = 70;
      const center = size / 2;
      let currentAngle = 0;

      const slices = data.map((item, index) => {
        const angle = (item.value / total) * 360;
        const startAngle = currentAngle;
        const endAngle = currentAngle + angle;
        currentAngle = endAngle;

        const startRad = (startAngle - 90) * Math.PI / 180;
        const endRad = (endAngle - 90) * Math.PI / 180;

        const x1 = center + radius * Math.cos(startRad);
        const y1 = center + radius * Math.sin(startRad);
        const x2 = center + radius * Math.cos(endRad);
        const y2 = center + radius * Math.sin(endRad);

        const largeArc = angle > 180 ? 1 : 0;
        const pathData = angle >= 359.9
          ? `M ${center} ${center - radius} A ${radius} ${radius} 0 1 1 ${center - 0.01} ${center - radius} Z`
          : `M ${center} ${center} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z`;

        const pct = (item.value / total) * 100;
        const pctStr = pct % 1 === 0 ? Math.round(pct) : pct.toFixed(1);

        return {
          path: pathData,
          color: CHART_COLORS[index % CHART_COLORS.length],
          label: item.label,
          value: item.value,
          pct: pctStr
        };
      });

      return (
        <div className="spe-chart-container">
          <p className="spe-chart-title">{title}</p>
          <div className="spe-chart-wrapper">
            <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} aria-hidden="true">
              {slices.map((slice, i) => (
                <path key={i} d={slice.path} fill={slice.color} stroke="white" strokeWidth="1" />
              ))}
            </svg>
            <div className="spe-chart-legend" role="list" aria-label="Légende du graphique">
              {slices.map((slice, i) => (
                <div key={i} className="spe-chart-legend-item" role="listitem">
                  <span className="spe-chart-legend-color" style={{ backgroundColor: slice.color }} aria-hidden="true"></span>
                  <span>{slice.label} ({slice.value} | {slice.pct} %)</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // ==========================================
    // APPLICATION PRINCIPALE
    // ==========================================
    function App() {
      // États
      const [mode, setMode] = useState('ministere');
      const [selectedMinistere, setSelectedMinistere] = useState('');
      const [selectedRegion, setSelectedRegion] = useState('');
      const [ministeres, setMinisteres] = useState(MINISTERES);
      const [regions, setRegions] = useState(REGIONS);
      const [data, setData] = useState([]);
      const [totalCount, setTotalCount] = useState(0);
      const [loading, setLoading] = useState(false);
      const [loadingProgress, setLoadingProgress] = useState('');
      const [error, setError] = useState(null);
      const [lastUpdate, setLastUpdate] = useState(null);
      const [availableYears, setAvailableYears] = useState(['2021', '2022', '2023', '2024']);
      const [selectedYear, setSelectedYear] = useState('2024');
      const [speClassification, setSpeClassification] = useState({});
      const [checkingSirets, setCheckingSirets] = useState(false);
      const [checkingProgress, setCheckingProgress] = useState('');
      const [searchQuery, setSearchQuery] = useState('');
      const [selectedSecteurs, setSelectedSecteurs] = useState([]);
      
      // Télédéclarations EGalim
      const [teledeclarations, setTeledeclarations] = useState({});
      const [loadingTD, setLoadingTD] = useState(false);
      
      // Limite d'affichage pour les performances
      const [displayLimit, setDisplayLimit] = useState(100);
      const INITIAL_DISPLAY_LIMIT = 100;

      // Pagination API (limite max de l'API tabular data.gouv.fr = 50)
      const pageSize = 50;

      // ==========================================
      // FONCTIONS UTILITAIRES
      // ==========================================
      const isTrueValue = (val) => val === true || val === 'True' || val === 'true' || val === '1';
      const isMissing = (val) => val === null || val === undefined || val === '' || val === '-';

      const translateManagementType = (type) => {
        if (!type) return '-';
        if (type === 'direct') return 'Gestion directe';
        if (type === 'conceded') return 'Gestion concédée';
        return type;
      };

      const hasMultipleSectors = (sectorList) => {
        if (!sectorList) return false;
        // Les secteurs multiples sont séparés par des virgules, des points-virgules ou des pipes
        // Note: le "/" fait partie de noms de secteurs valides (ex: "armées / police / gendarmerie")
        return sectorList.includes(',') || sectorList.includes(';') || sectorList.includes('|');
      };

      const formatPct = (pct) => {
        const num = parseFloat(pct);
        if (isNaN(num)) return '0 %';
        return num % 1 === 0 ? `${Math.round(num)} %` : `${num.toFixed(1)} %`;
      };

      const formatNumber = (num) => {
        return num.toLocaleString('fr-FR');
      };

      const formatLastUpdate = (dateStr) => {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleDateString('fr-FR', { 
          day: 'numeric', 
          month: 'long', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      };

      // Classification SPE
      const normalizeString = (str) => {
        if (!str) return '';
        return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();
      };

      const classifyEstablishment = (row, inseeData) => {
        if (!row) return 'ORANGE';
        
        const siret = row.siret ? row.siret.toString().trim() : '';
        const secteur = row.sector_list || '';
        const normalizedSecteur = normalizeString(secteur);
        const normalizedName = normalizeString(row.name || '');
        const lineMinistry = row.line_ministry || '';
        
        let cj = '';
        if (inseeData && inseeData.uniteLegale) {
          cj = inseeData.uniteLegale.categorieJuridiqueUniteLegale || '';
        }
        
        // AFPA = toujours SPE (établissement public de l'État)
        const isAFPA = normalizedName.includes('afpa') || 
                       normalizedName.includes('agence nationale pour la formation professionnelle');
        if (isAFPA) return 'BLANC';
        
        // Justice : établissements pénitentiaires et mess = SPE
        if (lineMinistry === 'Justice') {
          const justicePatterns = [
            /\bcp\b/i,           // Centre Pénitentiaire
            /\bcd\b/i,           // Centre de Détention
            /\bma\b/i,           // Maison d'Arrêt
            /\bmess\b/i,         // Mess
            /maison\s*d['']?\s*arr[eê]t/i  // Maison d'arrêt (forme longue)
          ];
          const isJusticeSPE = justicePatterns.some(pattern => pattern.test(row.name || ''));
          if (isJusticeSPE) return 'BLANC';
        }
        
        const hasOperatorMatch = SPE_RULES.operateurs_etat.some(op => 
          normalizedSecteur.includes(normalizeString(op)) || 
          normalizedName.includes(normalizeString(op))
        );
        
        const hasRiaMatch = normalizedSecteur.includes('ria') || normalizedSecteur.includes('inter-administratif');
        const hasEtatMatch = normalizedSecteur.includes('etat') || normalizedSecteur.includes('état');
        
        if ((hasOperatorMatch || hasRiaMatch) && cj.startsWith('72')) return 'ORANGE';
        if (hasOperatorMatch || hasRiaMatch || hasEtatMatch) return 'BLANC';
        
        const isSiretEtat = SPE_RULES.siret_prefixes_etat.some(p => siret.startsWith(p));
        if (isSiretEtat && !cj.startsWith('72')) return 'BLANC';
        
        const isSecteurEtat = SPE_RULES.secteurs_etat.some(s => normalizedSecteur.includes(normalizeString(s)));
        if (isSecteurEtat && !cj.startsWith('72')) return 'BLANC';
        
        const isCodeBlanc = SPE_RULES.codes_blanc.prefixes.some(p => cj.startsWith(p)) ||
                           SPE_RULES.codes_blanc.exacts.includes(cj);
        if (isCodeBlanc) return 'BLANC';
        
        const isCodeNoir = SPE_RULES.codes_noir.prefixes.some(p => cj.startsWith(p)) ||
                          SPE_RULES.codes_noir.exacts.includes(cj);
        if (isCodeNoir) return 'NOIR';
        
        return 'ORANGE';
      };

      // Vérification SIRET via API INSEE
      const checkSpeClassification = async (rows) => {
        if (!rows || rows.length === 0) return;
        
        setCheckingSirets(true);
        const classifications = { ...speClassification };
        const uniqueSirets = [...new Set(rows.map(r => r.siret).filter(s => s && !classifications[s]))];
        
        for (let i = 0; i < uniqueSirets.length; i++) {
          const siret = uniqueSirets[i];
          setCheckingProgress(`${i + 1}/${uniqueSirets.length}`);
          
          try {
            const response = await fetch(`https://api.insee.fr/entreprises/sirene/V3.11/siret/${siret}`, {
              headers: { 'Accept': 'application/json' }
            });
            
            if (response.ok) {
              const data = await response.json();
              const row = rows.find(r => r.siret === siret);
              classifications[siret] = classifyEstablishment(row, data.etablissement);
            } else {
              const row = rows.find(r => r.siret === siret);
              classifications[siret] = classifyEstablishment(row, null);
            }
          } catch {
            const row = rows.find(r => r.siret === siret);
            classifications[siret] = classifyEstablishment(row, null);
          }
          
          if (i % 10 === 0) {
            setSpeClassification({ ...classifications });
          }
        }
        
        setSpeClassification(classifications);
        setCheckingSirets(false);
        setCheckingProgress('');
      };

      // Détection des années de télédéclaration
      const detectDeclarationColumns = (dataRows) => {
        if (!dataRows || dataRows.length === 0) return ['2021', '2022', '2023', '2024'];
        const years = new Set(['2021', '2022', '2023', '2024']);
        const firstRow = dataRows[0];
        
        Object.keys(firstRow).forEach(key => {
          const match = key.match(/(\d{4})/);
          if (match && parseInt(match[1]) >= 2021 && parseInt(match[1]) <= 2025) {
            years.add(match[1]);
          }
        });
        
        return Array.from(years).sort();
      };

      const hasTeledeclaration = (row, yearId) => {
        if (!row || !yearId) return false;
        
        for (const key of Object.keys(row)) {
          if (key.includes(yearId) && isTrueValue(row[key])) return true;
        }
        return false;
      };

      // ==========================================
      // CHARGEMENT DES DONNÉES
      // ==========================================
      
      // Date de mise à jour
      useEffect(() => {
        const fetchLastUpdate = async () => {
          try {
            // Récupérer les infos depuis l'API tabulaire pour la date d'indexation
            const tabularResponse = await fetch(`https://tabular-api.data.gouv.fr/api/resources/${DATAGOUV_RESOURCE_ID}/`);
            if (tabularResponse.ok) {
              const tabularData = await tabularResponse.json();
              // L'API tabulaire retourne created_at qui correspond à la dernière indexation
              if (tabularData.created_at) {
                setLastUpdate(tabularData.created_at);
                return;
              }
            }
            
            // Fallback sur l'API catalog
            const response = await fetch(`https://www.data.gouv.fr/api/1/datasets/${DATAGOUV_DATASET_ID}/`);
            if (response.ok) {
              const data = await response.json();
              // Chercher la ressource CSV
              const resource = data.resources?.find(r => r.id === DATAGOUV_RESOURCE_ID);
              if (resource?.last_modified) {
                setLastUpdate(resource.last_modified);
              } else if (data.last_update) {
                // Fallback sur la date du dataset
                setLastUpdate(data.last_update);
              }
            }
          } catch (e) {
            console.error('Erreur date MAJ:', e);
          }
        };
        fetchLastUpdate();
      }, []);

      // Données principales
      useEffect(() => {
        const fetchData = async () => {
          if (mode === 'ministere' && !selectedMinistere) return;
          if (mode === 'region' && !selectedRegion) return;

          setLoading(true);
          setError(null);
          setSpeClassification({});
          setDisplayLimit(INITIAL_DISPLAY_LIMIT); // Reset la limite d'affichage

          try {
            let allData = [];
            let currentPage = 1;
            let hasMore = true;
            let totalRecords = 0;

            while (hasMore) {
              const params = new URLSearchParams();
              
              if (mode === 'ministere') {
                params.append('line_ministry__exact', selectedMinistere);
              } else {
                params.append('line_ministry__exact', "Préfecture - Administration Territoriale de l'État (ATE)");
                params.append('region_lib__exact', selectedRegion);
              }
              
              params.append('page', currentPage);
              params.append('page_size', pageSize);

              if (totalRecords > 0) {
                const totalPages = Math.ceil(totalRecords / pageSize);
                setLoadingProgress(`${allData.length} / ${totalRecords} établissements (page ${currentPage}/${totalPages})`);
              } else {
                setLoadingProgress(`Récupération des données...`);
              }
              
              const response = await fetch(`${API_PROXY}?${params.toString()}`);
              if (!response.ok) throw new Error(`Erreur API: ${response.status}`);
              
              const result = await response.json();
              const pageData = result.data || [];
              // L'API tabular data.gouv.fr renvoie le total dans meta.total
              totalRecords = result.meta?.total || result.total_count || 0;
              
              if (currentPage === 1) {
                const years = detectDeclarationColumns(pageData);
                setAvailableYears(years);
                if (years.length > 0) {
                  setSelectedYear(years[years.length - 1]);
                }
              }
              
              allData = [...allData, ...pageData];
              setLoadingProgress(`${allData.length} / ${totalRecords}`);
              
              hasMore = allData.length < totalRecords && pageData.length > 0;
              currentPage++;
              
              if (currentPage > 100) break;
            }

            setData(allData);
            setTotalCount(totalRecords);
            checkSpeClassification(allData);
          } catch (err) {
            setError(err.message);
          } finally {
            setLoading(false);
            setLoadingProgress('');
          }
        };

        fetchData();
      }, [mode, selectedMinistere, selectedRegion]);

      // Charger les télédéclarations après le chargement des données principales
      useEffect(() => {
        if (data.length === 0) return;
        
        const fetchTeledeclarations = async () => {
          setLoadingTD(true);
          const tdMap = {};
          
          try {
            // Récupérer les SIRET uniques
            const sirets = [...new Set(data.map(d => d.siret).filter(s => s))];
            if (sirets.length === 0) return;
            
            // Charger les TD pour l'année sélectionnée
            let allTD = [];
            let currentPage = 1;
            let hasMore = true;
            
            while (hasMore) {
              const params = new URLSearchParams();
              params.append('source', 'teledeclarations');
              params.append('td_year', selectedYear); // Sélectionner la bonne ressource
              
              if (mode === 'ministere') {
                params.append('canteen_line_ministry__exact', selectedMinistere);
              } else {
                params.append('canteen_line_ministry__exact', "Préfecture - Administration Territoriale de l'État (ATE)");
                params.append('canteen_region_lib__exact', selectedRegion);
              }
              
              params.append('page', currentPage);
              params.append('page_size', 50); // Limite max de l'API
              
              const response = await fetch(`${API_PROXY}?${params.toString()}`);
              if (!response.ok) break;
              
              const result = await response.json();
              const pageData = result.data || [];
              // L'API tabular data.gouv.fr renvoie le total dans meta.total
              const total = result.meta?.total || result.total_count || 0;
              
              allTD = [...allTD, ...pageData];
              hasMore = allTD.length < total && pageData.length > 0;
              currentPage++;
              
              if (currentPage > 50) break; // Limite de sécurité
            }
            
            // Indexer par SIRET (chaque ressource ne contient qu'une année)
            allTD.forEach(td => {
              const siret = td.canteen_siret;
              if (siret) {
                if (!tdMap[siret]) tdMap[siret] = {};
                tdMap[siret][selectedYear] = {
                  ratio_bio: td.teledeclaration_ratio_bio,
                  ratio_egalim: td.teledeclaration_ratio_egalim_hors_bio,
                  type: td.teledeclaration_type
                };
              }
            });
            
            setTeledeclarations(tdMap);
          } catch (e) {
            console.error('Erreur chargement TD:', e);
          } finally {
            setLoadingTD(false);
          }
        };
        
        fetchTeledeclarations();
      }, [data, mode, selectedMinistere, selectedRegion, selectedYear]);

      // ==========================================
      // DONNÉES FILTRÉES ET STATISTIQUES
      // ==========================================
      const filteredData = useMemo(() => {
        let filtered = data;
        
        if (searchQuery) {
          const q = searchQuery.toLowerCase();
          filtered = filtered.filter(row =>
            (row.name && row.name.toLowerCase().includes(q)) ||
            (row.siret && row.siret.includes(q)) ||
            (row.city && row.city.toLowerCase().includes(q))
          );
        }
        
        if (selectedSecteurs.length > 0) {
          filtered = filtered.filter(row =>
            selectedSecteurs.some(s => row.sector_list && row.sector_list.includes(s))
          );
        }
        
        return filtered;
      }, [data, searchQuery, selectedSecteurs]);

      const availableSecteurs = useMemo(() => {
        const secteurs = new Set();
        data.forEach(row => {
          if (row.sector_list) {
            row.sector_list.split(/[,;|]/).forEach(s => {
              const trimmed = s.trim();
              if (trimmed) secteurs.add(trimmed);
            });
          }
        });
        return Array.from(secteurs).sort();
      }, [data]);

      // Classification SPE d'une ligne
      const getSpeClass = (row) => {
        const siret = row.siret ? row.siret.toString().trim() : '';
        return speClassification[siret] || null;
      };

      const getSpeBadge = (row) => {
        const speClass = getSpeClass(row);
        if (speClass === 'BLANC') return { 
          text: 'Établissement SPE', 
          icon: 'fr-icon-checkbox-circle-fill',
          color: 'var(--text-default-success)'
        };
        if (speClass === 'NOIR') return { 
          text: 'Hors périmètre SPE', 
          icon: 'fr-icon-close-circle-fill',
          color: 'var(--text-mention-grey)'
        };
        if (speClass === 'ORANGE') return { 
          text: 'Classification à vérifier', 
          icon: 'fr-icon-question-fill',
          color: 'var(--text-default-warning)'
        };
        return null;
      };

      // Statistiques principales
      const stats = useMemo(() => {
        const totalApi = totalCount > 0 ? totalCount : data.length;
        const totalFiltered = filteredData.length;
        
        const td = {};
        availableYears.forEach(yearId => {
          const count = filteredData.filter(d => hasTeledeclaration(d, yearId)).length;
          td[yearId] = {
            count,
            pct: totalFiltered > 0 ? ((count / totalFiltered) * 100).toFixed(1) : 0
          };
        });

        const actifs = filteredData.filter(d => isTrueValue(d.active_on_ma_cantine)).length;

        return {
          totalApi,
          totalFiltered,
          td,
          actifs: { count: actifs, pct: totalFiltered > 0 ? (actifs / totalFiltered * 100).toFixed(1) : 0 }
        };
      }, [data, filteredData, totalCount, availableYears]);

      // Stats RIA (mode ATE)
      const riaStats = useMemo(() => {
        if (mode !== 'region' || !selectedRegion) return null;
        const riaCount = filteredData.filter(row => {
          const sector = row.sector_list || '';
          return sector.includes('RIA') || sector.includes('inter-administratif');
        }).length;
        const cible = CIBLE_RIA_DGAFP[selectedRegion] || 0;
        const pct = cible > 0 ? ((riaCount / cible) * 100).toFixed(1) : 0;
        return { count: riaCount, cible, pct };
      }, [mode, selectedRegion, filteredData]);

      // Stats erreurs
      const errorStats = useMemo(() => {
        const errors = {
          no_active_manager: 0, siret: 0, name: 0, daily_meal_count: 0,
          production_type: 0, management_type: 0, economic_model: 0, 
          economic_model_private: 0, multiple_sectors: 0
        };
        let total = 0;
        
        filteredData.forEach(row => {
          let hasError = false;
          if (!isTrueValue(row.active_on_ma_cantine)) { errors.no_active_manager++; hasError = true; }
          if (isMissing(row.siret)) { errors.siret++; hasError = true; }
          if (isMissing(row.name)) { errors.name++; hasError = true; }
          if (isMissing(row.daily_meal_count)) { errors.daily_meal_count++; hasError = true; }
          if (isMissing(row.production_type)) { errors.production_type++; hasError = true; }
          if (isMissing(row.management_type)) { errors.management_type++; hasError = true; }
          if (isMissing(row.economic_model)) { errors.economic_model++; hasError = true; }
          else if (row.economic_model !== 'public') { errors.economic_model_private++; hasError = true; }
          if (hasMultipleSectors(row.sector_list)) { errors.multiple_sectors++; hasError = true; }
          if (hasError) total++;
        });

        return { errors, total };
      }, [filteredData]);

      // Stats SPE
      const speStats = useMemo(() => {
        const stats = { BLANC: 0, NOIR: 0, ORANGE: 0, INCONNU: 0 };
        filteredData.forEach(row => {
          const siret = row.siret ? row.siret.toString().trim() : '';
          const classification = speClassification[siret];
          if (classification) stats[classification]++;
          else stats.INCONNU++;
        });
        return stats;
      }, [filteredData, speClassification]);

      // Stats par type de gestion
      const managementStats = useMemo(() => {
        const groups = {};
        filteredData.forEach(d => {
          const type = translateManagementType(d.management_type) || 'Non renseigné';
          groups[type] = (groups[type] || 0) + 1;
        });
        return Object.entries(groups)
          .map(([label, value]) => ({ label, value }))
          .sort((a, b) => b.value - a.value);
      }, [filteredData]);

      // Stats par région (mode ministère)
      const regionStats = useMemo(() => {
        if (mode !== 'ministere') return [];
        const groups = {};
        filteredData.forEach(d => {
          const region = d.region_lib || 'Non renseigné';
          groups[region] = (groups[region] || 0) + 1;
        });
        return Object.entries(groups)
          .map(([label, value]) => ({ label, value }))
          .sort((a, b) => b.value - a.value);
      }, [filteredData, mode]);

      // Moyennes repas
      const mealStats = useMemo(() => {
        const validDaily = filteredData.filter(d => d.daily_meal_count && !isNaN(d.daily_meal_count));
        const avgDaily = validDaily.length > 0 
          ? Math.round(validDaily.reduce((sum, d) => sum + Number(d.daily_meal_count), 0) / validDaily.length)
          : 0;
        
        const validYearly = filteredData.filter(d => d.yearly_meal_count && !isNaN(d.yearly_meal_count));
        const avgYearly = validYearly.length > 0 
          ? Math.round(validYearly.reduce((sum, d) => sum + Number(d.yearly_meal_count), 0) / validYearly.length)
          : 0;
        
        return { avgDaily, avgYearly };
      }, [filteredData]);

      // Statistiques EGalim (ratios bio et EGalim)
      const egalimStats = useMemo(() => {
        if (Object.keys(teledeclarations).length === 0) {
          return { avgBio: null, avgEgalim: null, count: 0, total: filteredData.length };
        }
        
        let sumBio = 0, countBio = 0;
        let sumEgalim = 0, countEgalim = 0;
        
        filteredData.forEach(row => {
          const siret = row.siret;
          const td = teledeclarations[siret]?.[selectedYear];
          if (td) {
            if (td.ratio_bio !== null && td.ratio_bio !== undefined && !isNaN(td.ratio_bio)) {
              sumBio += Number(td.ratio_bio);
              countBio++;
            }
            if (td.ratio_egalim !== null && td.ratio_egalim !== undefined && !isNaN(td.ratio_egalim)) {
              sumEgalim += Number(td.ratio_egalim);
              countEgalim++;
            }
          }
        });
        
        return {
          avgBio: countBio > 0 ? (sumBio / countBio * 100) : null,
          avgEgalim: countEgalim > 0 ? (sumEgalim / countEgalim * 100) : null,
          count: countBio,
          total: filteredData.length
        };
      }, [filteredData, teledeclarations, selectedYear]);

      // Style de ligne tableau
      const getRowClassName = (row) => {
        const speClass = getSpeClass(row);
        if (speClass === 'NOIR') return 'spe-row-excluded';
        
        const hasError = !isTrueValue(row.active_on_ma_cantine) ||
                        isMissing(row.siret) || isMissing(row.name) || 
                        isMissing(row.daily_meal_count) || isMissing(row.production_type) ||
                        isMissing(row.management_type) || isMissing(row.economic_model) ||
                        (row.economic_model && row.economic_model !== 'public') ||
                        hasMultipleSectors(row.sector_list);
        
        if (hasError) return 'spe-row-error';
        
        const hasTD = selectedYear && hasTeledeclaration(row, selectedYear);
        if (hasTD) return 'spe-row-success';
        if (selectedYear) return 'spe-row-warning';
        
        return '';
      };

      // Fonction de priorité de tri (ordre croissant = affiché en premier)
      const getRowSortPriority = (row) => {
        const speClass = getSpeClass(row);
        if (speClass === 'NOIR') return 1; // Hors périmètre SPE
        if (speClass === 'ORANGE') return 2; // À vérifier
        
        const hasError = !isTrueValue(row.active_on_ma_cantine) ||
                        isMissing(row.siret) || isMissing(row.name) || 
                        isMissing(row.daily_meal_count) || isMissing(row.production_type) ||
                        isMissing(row.management_type) || isMissing(row.economic_model) ||
                        (row.economic_model && row.economic_model !== 'public') ||
                        hasMultipleSectors(row.sector_list);
        if (hasError) return 3; // Information à corriger
        
        const hasTD = selectedYear && hasTeledeclaration(row, selectedYear);
        if (!hasTD && selectedYear) return 4; // Télédéclaration à effectuer
        
        return 5; // Télédéclaration effectuée
      };

      // Données triées par priorité
      const sortedData = useMemo(() => {
        return [...filteredData].sort((a, b) => getRowSortPriority(a) - getRowSortPriority(b));
      }, [filteredData, speClassification, selectedYear]);

      // Données affichées (limitées pour les performances)
      const displayedData = useMemo(() => {
        return sortedData.slice(0, displayLimit);
      }, [sortedData, displayLimit]);

      // Normaliser un nom pour le fichier (supprimer accents et caractères spéciaux)
      const normalizeFilename = (str) => {
        return str
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-zA-Z0-9]/g, '_')
          .replace(/_+/g, '_')
          .replace(/^_|_$/g, '');
      };

      // Export CSV établissements - URL directe vers l'API tabular data.gouv.fr (ressource XLSX)
      const getExportUrl = () => {
        const params = new URLSearchParams();
        if (mode === 'ministere') {
          params.append('line_ministry__exact', selectedMinistere);
        } else {
          params.append('line_ministry__exact', "Préfecture - Administration Territoriale de l'État (ATE)");
          params.append('region_lib__exact', selectedRegion);
        }
        return `https://tabular-api.data.gouv.fr/api/resources/${DATAGOUV_RESOURCE_ID}/data/csv/?${params.toString()}`;
      };

      // Nom du fichier établissements
      const getExportFilename = () => {
        if (mode === 'ministere') {
          return `etablissements_${normalizeFilename(selectedMinistere)}.csv`;
        } else {
          return `etablissements_${normalizeFilename(selectedRegion)}.csv`;
        }
      };

      // Ressources TD par année
      const TD_RESOURCES = {
        '2024': '078cbd12-b553-4d0b-b74c-e79b19f7f61f',
        '2023': '25570c1c-9288-4fed-9d82-0f42444e12ab',
        '2022': '84a09799-0845-4055-9101-e3a1a00fac2f',
        '2021': 'efe63a1a-c307-4238-81b0-ffa8536163c7'
      };

      // Export CSV télédéclarations
      const getTDExportUrl = () => {
        const resourceId = TD_RESOURCES[selectedYear] || TD_RESOURCES['2024'];
        const params = new URLSearchParams();
        if (mode === 'ministere') {
          params.append('canteen_line_ministry__exact', selectedMinistere);
        } else {
          params.append('canteen_line_ministry__exact', "Préfecture - Administration Territoriale de l'État (ATE)");
          params.append('canteen_region_lib__exact', selectedRegion);
        }
        return `https://tabular-api.data.gouv.fr/api/resources/${resourceId}/data/csv/?${params.toString()}`;
      };

      // Nom du fichier TD
      const getTDExportFilename = () => {
        const campagne = parseInt(selectedYear) + 1;
        if (mode === 'ministere') {
          return `teledeclarations_campagne${campagne}_${normalizeFilename(selectedMinistere)}.csv`;
        } else {
          return `teledeclarations_campagne${campagne}_${normalizeFilename(selectedRegion)}.csv`;
        }
      };

      // État de téléchargement
      const [downloading, setDownloading] = useState(null);

      // Fonction de téléchargement avec nom de fichier forcé (contourne la restriction cross-origin)
      const handleDownload = async (url, filename, type) => {
        setDownloading(type);
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error('Erreur de téléchargement');
          const blob = await response.blob();
          const blobUrl = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = blobUrl;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(blobUrl);
        } catch (e) {
          console.error('Erreur téléchargement:', e);
          // Fallback: ouvrir l'URL directement
          window.open(url, '_blank');
        } finally {
          setDownloading(null);
        }
      };

      // ==========================================
      // RENDU
      // ==========================================
      return (
        <div className="fr-container fr-py-4w">
          {/* Bandeau info date MAJ */}
          {lastUpdate && (
            <div className="fr-alert fr-alert--info fr-mb-4w">
              <p>
                Données mises à jour le {formatLastUpdate(lastUpdate)} | Source : {' '}
                <a href="https://data.gouv.fr/fr/datasets/registre-national-des-cantines/" target="_blank" rel="noopener" title="Registre national des cantines - nouvelle fenêtre">
                  Registre national des cantines (data.gouv.fr)
                </a>
              </p>
            </div>
          )}

          {/* Sélection du périmètre */}
          <div className="fr-grid-row fr-grid-row--gutters fr-mb-4w">
            <div className="fr-col-12 fr-col-md-4">
              <fieldset className="fr-fieldset">
                <legend className="fr-fieldset__legend fr-text--bold">Périmètre d'analyse</legend>
                <div className="fr-fieldset__content">
                  <div className="fr-btns-group fr-btns-group--inline-sm">
                    <button
                      type="button"
                      className={mode === 'ministere' ? 'fr-btn' : 'fr-btn fr-btn--secondary'}
                      onClick={() => { setMode('ministere'); setSelectedRegion(''); setSelectedMinistere(''); setData([]); }}
                      aria-pressed={mode === 'ministere'}
                    >
                      Ministère
                    </button>
                    <button
                      type="button"
                      className={mode === 'region' ? 'fr-btn' : 'fr-btn fr-btn--secondary'}
                      onClick={() => { setMode('region'); setSelectedMinistere(''); setSelectedRegion(''); setData([]); }}
                      aria-pressed={mode === 'region'}
                    >
                      ATE Région
                    </button>
                  </div>
                </div>
              </fieldset>
            </div>
            
            <div className="fr-col-12 fr-col-md-4">
              {mode === 'ministere' ? (
                <div className="fr-select-group">
                  <label className="fr-label" htmlFor="select-ministere">Ministère</label>
                  <select
                    className="fr-select"
                    id="select-ministere"
                    value={selectedMinistere}
                    onChange={(e) => { setSelectedMinistere(e.target.value); setData([]); }}
                  >
                    <option value="">Sélectionner un ministère</option>
                    {ministeres.map(m => (
                      <option key={m} value={m}>{m}</option>
                    ))}
                  </select>
                </div>
              ) : (
                <div className="fr-select-group">
                  <label className="fr-label" htmlFor="select-region">Région</label>
                  <select
                    className="fr-select"
                    id="select-region"
                    value={selectedRegion}
                    onChange={(e) => { setSelectedRegion(e.target.value); setData([]); }}
                  >
                    <option value="">Sélectionner une région</option>
                    {regions.map(r => (
                      <option key={r} value={r}>{r}</option>
                    ))}
                  </select>
                </div>
              )}
            </div>
            
            <div className="fr-col-12 fr-col-md-4">
              <div className="fr-select-group">
                <label className="fr-label" htmlFor="select-year">Campagne de télédéclaration</label>
                <select
                  className="fr-select"
                  id="select-year"
                  value={selectedYear}
                  onChange={(e) => setSelectedYear(e.target.value)}
                >
                  {availableYears.map(y => (
                    <option key={y} value={y}>Campagne {parseInt(y) + 1} (données {y})</option>
                  ))}
                </select>
              </div>
            </div>
          </div>
          
          {/* Filtre par secteur - visible uniquement si données chargées */}
          {data.length > 0 && availableSecteurs.length > 1 && (
            <div className="fr-grid-row fr-mb-4w">
              <div className="fr-col-12 fr-col-md-6">
                <div className="fr-select-group">
                  <label className="fr-label" htmlFor="select-secteur">Filtre par secteur</label>
                  <select
                    className="fr-select"
                    id="select-secteur"
                    value={selectedSecteurs.length === 1 ? selectedSecteurs[0] : ''}
                    onChange={(e) => setSelectedSecteurs(e.target.value ? [e.target.value] : [])}
                  >
                    <option value="">Tous les secteurs ({availableSecteurs.length})</option>
                    {availableSecteurs.map(s => (
                      <option key={s} value={s}>{s}</option>
                    ))}
                  </select>
                </div>
              </div>
            </div>
          )}

          {/* Chargement */}
          {loading && (
            <div className="fr-callout fr-mb-4w" role="status" aria-live="polite">
              <p className="fr-callout__text">
                <span className="spe-spinner fr-mr-2w" aria-hidden="true"></span>
                Chargement en cours : {loadingProgress}
              </p>
            </div>
          )}

          {/* Erreur */}
          {error && (
            <div className="fr-alert fr-alert--error fr-mb-4w" role="alert">
              <p className="fr-alert__title">Erreur</p>
              <p>{error}</p>
            </div>
          )}

          {/* Contenu principal */}
          {!loading && !error && data.length > 0 && (
            <>
              {/* KPIs principaux */}
              <div className="fr-grid-row fr-grid-row--gutters fr-mb-4w">
                <div className="fr-col-12 fr-col-md-6">
                  <div className="spe-stat-item spe-stat-item--main spe-stat-item--accent">
                    <p className="spe-stat-label" style={{ color: 'var(--text-inverted-grey)' }}>
                      Établissements rattachés au périmètre
                    </p>
                    <p className="spe-stat-value" style={{ color: 'var(--text-inverted-grey)' }}>
                      {formatNumber(stats.totalApi)}
                    </p>
                  </div>
                </div>
                <div className="fr-col-12 fr-col-md-6">
                  <div className="spe-stat-item spe-stat-item--main spe-stat-item--raised">
                    <p className="spe-stat-label">
                      Taux de télédéclaration {selectedYear}
                    </p>
                    <p className={`spe-stat-value ${parseFloat(stats.td[selectedYear]?.pct || 0) >= 100 ? 'spe-stat-value--success' : 'spe-stat-value--warning'}`}>
                      {stats.td[selectedYear] ? formatPct(stats.td[selectedYear].pct) : '0 %'}
                    </p>
                    <p className="spe-stat-detail">
                      ({stats.td[selectedYear]?.count || 0} / {stats.totalFiltered} établissements)
                    </p>
                  </div>
                </div>
              </div>

              {/* KPI RIA pour ATE */}
              {mode === 'region' && riaStats && riaStats.cible > 0 && (
                <div className="fr-alert fr-alert--warning fr-mb-4w">
                  <p className="fr-alert__title">RIA recensés par la DGAFP (cible au 1er novembre 2025)</p>
                  <p className="fr-text--lg fr-text--bold fr-text--center fr-mt-2w">
                    <span className={riaStats.count >= riaStats.cible ? 'spe-stat-value--success' : 'spe-stat-value--warning'}>
                      {riaStats.count}
                    </span>
                    {' / '}
                    {riaStats.cible}
                    {' | '}
                    <span className={riaStats.count >= riaStats.cible ? 'spe-stat-value--success' : 'spe-stat-value--warning'}>
                      {formatPct(riaStats.pct)}
                    </span>
                  </p>
                </div>
              )}

              {/* KPIs secondaires */}
              <div className="fr-grid-row fr-grid-row--gutters fr-mb-4w">
                <div className="fr-col-6 fr-col-md-4">
                  <div className="spe-stat-item spe-stat-item--alt">
                    <p className="spe-stat-label">Comptes actifs</p>
                    <p className={`spe-stat-value ${parseFloat(stats.actifs.pct) >= 100 ? 'spe-stat-value--success' : 'spe-stat-value--warning'}`}>
                      {formatPct(stats.actifs.pct)}
                    </p>
                    <p className="spe-stat-detail">({stats.actifs.count} / {stats.totalFiltered})</p>
                  </div>
                </div>
                <div className="fr-col-6 fr-col-md-4">
                  <div className="spe-stat-item spe-stat-item--alt">
                    <p className="spe-stat-label">Moy. couverts/jour</p>
                    <p className="spe-stat-value">{formatNumber(mealStats.avgDaily)}</p>
                  </div>
                </div>
                <div className="fr-col-12 fr-col-md-4">
                  <div className="spe-stat-item spe-stat-item--alt">
                    <p className="spe-stat-label">Moy. couverts/an</p>
                    <p className="spe-stat-value">{formatNumber(mealStats.avgYearly)}</p>
                  </div>
                </div>
              </div>

              {/* Graphiques */}
              <div className="fr-grid-row fr-grid-row--gutters fr-mb-4w">
                {managementStats.length > 0 && (
                  <div className="fr-col-12 fr-col-md-6">
                    <PieChart data={managementStats} title="Répartition par type de gestion" />
                  </div>
                )}
                {mode === 'ministere' && regionStats.length > 0 && (
                  <div className="fr-col-12 fr-col-md-6">
                    <PieChart data={regionStats} title="Répartition par région" />
                  </div>
                )}
              </div>

              {/* Légende (gauche) + Classification SPE et Erreurs (droite) */}
              <div className="fr-grid-row fr-grid-row--gutters fr-mb-4w" style={{ alignItems: 'stretch' }}>
                {/* Colonne gauche : Légende */}
                <div className="fr-col-12 fr-col-md-6" style={{ display: 'flex' }}>
                  <div className="fr-callout fr-callout--brown-caramel" style={{ flex: 1, marginBottom: 0 }}>
                    <p className="fr-callout__title">Légende</p>
                    <div className="fr-callout__text">
                      <p className="fr-mb-1w"><strong>Couleurs des lignes :</strong></p>
                      <ul className="fr-mb-2w">
                        <li><span className="spe-legend-color spe-legend-color--error">Rouge</span> : Information à corriger</li>
                        <li><span className="spe-legend-color spe-legend-color--warning">Jaune</span> : Télédéclaration à effectuer</li>
                        <li><span className="spe-legend-color spe-legend-color--success">Vert</span> : Télédéclaration effectuée</li>
                      </ul>
                      <p className="fr-mb-1w"><strong>Colonne SPE :</strong></p>
                      <ul>
                        <li><span className="fr-icon-checkbox-circle-fill fr-icon--sm fr-mr-1v" style={{ color: 'var(--text-default-success)' }} aria-hidden="true"></span> Établissement SPE</li>
                        <li><span className="fr-icon-close-circle-fill fr-icon--sm fr-mr-1v" style={{ color: 'var(--text-mention-grey)' }} aria-hidden="true"></span> Hors périmètre SPE</li>
                        <li><span className="fr-icon-question-fill fr-icon--sm fr-mr-1v" style={{ color: 'var(--text-default-warning)' }} aria-hidden="true"></span> À vérifier</li>
                      </ul>
                    </div>
                  </div>
                </div>
                
                {/* Colonne droite : Classification SPE + Erreurs */}
                <div className="fr-col-12 fr-col-md-6" style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                  {/* Classification SPE */}
                  <div className="fr-callout" style={{ flex: 1, marginBottom: 0 }}>
                    <p className="fr-callout__title" style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                      Classification SPE
                      <button 
                        className="fr-btn--tooltip fr-btn" 
                        aria-describedby="tooltip-classification-spe"
                      >
                        Information
                      </button>
                      <span className="fr-tooltip fr-placement" id="tooltip-classification-spe" role="tooltip" aria-hidden="true">
                        La classification SPE est fournie à titre indicatif. En cas de doute, contactez la DGAL via le bouton "Nous contacter" en haut de page.
                      </span>
                    </p>
                    <div className="fr-callout__text">
                      <div className="fr-grid-row fr-grid-row--gutters">
                        <div className="fr-col-4" style={{ textAlign: 'center' }}>
                          <p className="spe-stat-label">SPE</p>
                          <p className="spe-stat-value spe-stat-value--success">
                            <span className="fr-icon-checkbox-circle-fill fr-icon--sm fr-mr-1v" aria-hidden="true"></span>{speStats.BLANC}
                          </p>
                        </div>
                        <div className="fr-col-4" style={{ textAlign: 'center' }}>
                          <p className="spe-stat-label">Hors SPE</p>
                          <p className="spe-stat-value">
                            <span className="fr-icon-close-circle-fill fr-icon--sm fr-mr-1v" aria-hidden="true"></span>{speStats.NOIR}
                          </p>
                        </div>
                        <div className="fr-col-4" style={{ textAlign: 'center' }}>
                          <p className="spe-stat-label">À vérifier</p>
                          <p className="spe-stat-value spe-stat-value--warning">
                            <span className="fr-icon-question-fill fr-icon--sm fr-mr-1v" aria-hidden="true"></span>{speStats.ORANGE}
                          </p>
                        </div>
                      </div>
                      {checkingSirets && (
                        <p className="spe-stat-detail fr-mt-2w">Vérification en cours ({checkingProgress})</p>
                      )}
                    </div>
                  </div>
                  
                  {/* Erreurs */}
                  {errorStats.total > 0 ? (
                    <div className="fr-alert fr-alert--error" style={{ flex: 1, marginBottom: 0 }}>
                      <p className="fr-alert__title">
                        {errorStats.total === 1 
                          ? '1 établissement avec information à corriger' 
                          : `${errorStats.total} établissements avec informations à corriger`}
                      </p>
                      <ul className="fr-mt-2w">
                        {errorStats.errors.no_active_manager > 0 && <li>Gestionnaire non actif : {errorStats.errors.no_active_manager}</li>}
                        {errorStats.errors.siret > 0 && <li>SIRET manquant : {errorStats.errors.siret}</li>}
                        {errorStats.errors.name > 0 && <li>Nom manquant : {errorStats.errors.name}</li>}
                        {errorStats.errors.daily_meal_count > 0 && <li>Couverts/jour manquant : {errorStats.errors.daily_meal_count}</li>}
                        {errorStats.errors.production_type > 0 && <li>Type de production manquant : {errorStats.errors.production_type}</li>}
                        {errorStats.errors.management_type > 0 && <li>Type de gestion manquant : {errorStats.errors.management_type}</li>}
                        {errorStats.errors.economic_model > 0 && <li>Modèle économique manquant : {errorStats.errors.economic_model}</li>}
                        {errorStats.errors.economic_model_private > 0 && <li>Modèle économique non public : {errorStats.errors.economic_model_private}</li>}
                        {errorStats.errors.multiple_sectors > 0 && <li>Plusieurs secteurs renseignés : {errorStats.errors.multiple_sectors}</li>}
                      </ul>
                    </div>
                  ) : (
                    <div className="fr-alert fr-alert--success" style={{ flex: 1, marginBottom: 0 }}>
                      <p>Aucune erreur détectée sur les informations des établissements.</p>
                    </div>
                  )}
                </div>
              </div>

              {/* Tableau des établissements */}
              <div className="fr-mb-4w">
                <div className="fr-grid-row fr-grid-row--middle fr-mb-2w">
                  <div className="fr-col">
                    <p className="fr-text--bold fr-mb-0">
                      Établissements ({filteredData.length})
                    </p>
                  </div>
                  <div className="fr-col-auto">
                    <div className="fr-search-bar" role="search">
                      <label className="fr-label fr-sr-only" htmlFor="search-table">Rechercher</label>
                      <input
                        className="fr-input"
                        placeholder="Rechercher..."
                        type="search"
                        id="search-table"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                      />
                      <button className="fr-btn" title="Rechercher" type="button">
                        Rechercher
                      </button>
                    </div>
                  </div>
                </div>
                
                {/* Téléchargements */}
                <div className="fr-mb-2w">
                  <div className="fr-grid-row fr-grid-row--gutters fr-grid-row--middle">
                    <div className="fr-col-auto">
                      <button
                        className="fr-btn fr-btn--secondary fr-btn--sm fr-btn--icon-left fr-icon-download-line"
                        onClick={() => handleDownload(getExportUrl(), getExportFilename(), 'etablissements')}
                        disabled={downloading !== null}
                      >
                        {downloading === 'etablissements' ? 'Téléchargement...' : 'Télécharger les établissements (CSV)'}
                      </button>
                    </div>
                    {selectedYear && (
                      <div className="fr-col-auto">
                        <button
                          className="fr-btn fr-btn--secondary fr-btn--sm fr-btn--icon-left fr-icon-download-line"
                          onClick={() => handleDownload(getTDExportUrl(), getTDExportFilename(), 'teledeclarations')}
                          disabled={downloading !== null}
                        >
                          {downloading === 'teledeclarations' ? 'Téléchargement...' : 'Télécharger les télédéclarations (CSV)'}
                        </button>
                      </div>
                    )}
                    <div className="fr-col-auto">
                      <a href="https://ma-cantine.crisp.help/fr/article/comment-importer-un-fichier-csv-dans-excel-7zyxo/#1-ouvrir-un-fichier-csv-sur-excel" target="_blank" rel="noopener" title="Comment importer un CSV dans Excel - nouvelle fenêtre" className="fr-link fr-text--xs">
                        Comment importer un CSV dans Excel ?
                      </a>
                    </div>
                  </div>
                </div>

                <div className="fr-table fr-table--bordered" style={{ overflowX: 'auto' }}>
                  <table>
                    <thead>
                      <tr>
                        <th scope="col">SPE</th>
                        <th scope="col">Nom</th>
                        <th scope="col">SIRET</th>
                        <th scope="col">Ville</th>
                        <th scope="col">Département</th>
                        <th scope="col">Secteur</th>
                        <th scope="col">Type gestion</th>
                        <th scope="col">Modèle éco.</th>
                        <th scope="col" style={{ textAlign: 'center' }}>Actif</th>
                        {availableYears.map(y => (
                          <th key={y} scope="col" style={{ textAlign: 'center' }}>{y}</th>
                        ))}
                        <th scope="col" style={{ textAlign: 'center' }} title={`% achats Bio (données ${selectedYear})`}>% Bio ({selectedYear})</th>
                        <th scope="col" style={{ textAlign: 'center' }} title={`% achats EGalim hors bio (données ${selectedYear})`}>% Qualité hors bio ({selectedYear})</th>
                        <th scope="col" style={{ textAlign: 'center' }} title={`% total EGalim incluant bio (données ${selectedYear})`}>% EGalim total ({selectedYear})</th>
                      </tr>
                    </thead>
                    <tbody>
                      {displayedData.map((row, i) => (
                        <tr key={row.id || i} className={getRowClassName(row)}>
                          <td style={{ textAlign: 'center' }}>
                            {getSpeBadge(row) ? (
                              <span 
                                className={getSpeBadge(row).icon} 
                                title={getSpeBadge(row).text}
                                style={{ color: getSpeBadge(row).color }}
                                aria-label={getSpeBadge(row).text}
                              ></span>
                            ) : (
                              <span className="spe-spinner" style={{ width: '1rem', height: '1rem' }}></span>
                            )}
                          </td>
                          <td className="spe-word-break" style={{ maxWidth: '12.5rem' }}>
                            {isMissing(row.name) ? <span className="spe-text-error"><span className="fr-icon-warning-fill fr-icon--sm" aria-hidden="true"></span> -</span> : row.name}
                          </td>
                          <td className="spe-text-mono">
                            {isMissing(row.siret) ? <span className="spe-text-error"><span className="fr-icon-warning-fill fr-icon--sm" aria-hidden="true"></span> -</span> : row.siret}
                          </td>
                          <td>{row.city || '-'}</td>
                          <td>{row.department_lib || '-'}</td>
                          <td className="spe-word-break" style={{ maxWidth: '11.25rem' }}>
                            {hasMultipleSectors(row.sector_list) ? (
                              <span className="spe-text-error"><span className="fr-icon-warning-fill fr-icon--sm" aria-hidden="true"></span> {row.sector_list}</span>
                            ) : (
                              row.sector_list || '-'
                            )}
                          </td>
                          <td>
                            {isMissing(row.management_type) ? (
                              <span className="spe-text-error"><span className="fr-icon-warning-fill fr-icon--sm" aria-hidden="true"></span> -</span>
                            ) : (
                              translateManagementType(row.management_type)
                            )}
                          </td>
                          <td>
                            {isMissing(row.economic_model) ? (
                              <span className="spe-text-error"><span className="fr-icon-warning-fill fr-icon--sm" aria-hidden="true"></span> -</span>
                            ) : row.economic_model !== 'public' ? (
                              <span className="spe-text-error"><span className="fr-icon-warning-fill fr-icon--sm" aria-hidden="true"></span> {row.economic_model === 'private' ? 'privé' : row.economic_model}</span>
                            ) : (
                              <span style={{ color: 'var(--text-default-success)' }}>public</span>
                            )}
                          </td>
                          <td style={{ textAlign: 'center' }}>
                            {isTrueValue(row.active_on_ma_cantine) ? (
                              <span style={{ color: 'var(--text-default-success)' }}>oui</span>
                            ) : (
                              <span className="spe-text-error"><span className="fr-icon-warning-fill fr-icon--sm" aria-hidden="true"></span> non</span>
                            )}
                          </td>
                          {availableYears.map(y => (
                            <td key={y} style={{ textAlign: 'center' }}>
                              {hasTeledeclaration(row, y) ? (
                                <span className="fr-icon-checkbox-circle-fill fr-icon--sm" style={{ color: 'var(--text-default-success)' }} aria-label="Oui"></span>
                              ) : (
                                <span className="fr-icon-close-circle-fill fr-icon--sm" style={{ color: 'var(--text-default-error)' }} aria-label="Non"></span>
                              )}
                            </td>
                          ))}
                          <td style={{ textAlign: 'center', whiteSpace: 'nowrap' }}>
                            {(() => {
                              const td = teledeclarations[row.siret]?.[selectedYear];
                              if (!td || td.ratio_bio === null || td.ratio_bio === undefined) return '-';
                              const pctValue = Number(td.ratio_bio) * 100;
                              const isGood = pctValue >= 20;
                              return <span style={{ color: isGood ? 'var(--text-default-success)' : 'var(--text-default-warning)' }}>{formatPct(pctValue)}</span>;
                            })()}
                          </td>
                          <td style={{ textAlign: 'center', whiteSpace: 'nowrap' }}>
                            {(() => {
                              const td = teledeclarations[row.siret]?.[selectedYear];
                              if (!td || td.ratio_egalim === null || td.ratio_egalim === undefined) return '-';
                              const pctValue = Number(td.ratio_egalim) * 100;
                              return <span>{formatPct(pctValue)}</span>;
                            })()}
                          </td>
                          <td style={{ textAlign: 'center', whiteSpace: 'nowrap' }}>
                            {(() => {
                              const td = teledeclarations[row.siret]?.[selectedYear];
                              if (!td) return '-';
                              const bio = td.ratio_bio ? Number(td.ratio_bio) * 100 : 0;
                              const egalim = td.ratio_egalim ? Number(td.ratio_egalim) * 100 : 0;
                              if (td.ratio_bio === null && td.ratio_egalim === null) return '-';
                              const total = bio + egalim;
                              const isGood = total >= 50;
                              return <span style={{ color: isGood ? 'var(--text-default-success)' : 'var(--text-default-warning)' }}>{formatPct(total)}</span>;
                            })()}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                
                {/* Bouton Afficher plus */}
                {sortedData.length > displayLimit && (
                  <div className="fr-mt-2w" style={{ textAlign: 'center' }}>
                    <button 
                      className="fr-btn fr-btn--secondary"
                      onClick={() => setDisplayLimit(prev => prev + 100)}
                    >
                      Afficher plus ({displayLimit} / {sortedData.length} établissements)
                    </button>
                    <button 
                      className="fr-btn fr-btn--tertiary-no-outline fr-ml-2w"
                      onClick={() => setDisplayLimit(sortedData.length)}
                    >
                      Tout afficher
                    </button>
                  </div>
                )}
              </div>
            </>
          )}

          {/* État vide */}
          {!loading && !error && data.length === 0 && (selectedMinistere || selectedRegion) && (
            <div className="fr-callout">
              <p className="fr-callout__text">
                Aucun établissement trouvé pour ce périmètre.
              </p>
            </div>
          )}

          {/* Invitation à sélectionner */}
          {!loading && !error && !selectedMinistere && !selectedRegion && (
            <div className="fr-callout">
              <p className="fr-callout__text">
                Sélectionnez un ministère ou une région pour afficher les données.
              </p>
            </div>
          )}
        </div>
      );
    }

    // Rendu React
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
  
  <!-- Script mode sombre après chargement DSFR -->
  <script>
    /**
     * Deuil national - Pour activer, définir DEUIL_NATIONAL = true
     * ou ajouter ?deuil=1 dans l'URL
     * L'attribut data-fr-mourning est ajouté sur <html> pour passer la Marianne en N&B
     */
    const DEUIL_NATIONAL = false; // Modifier à true en période de deuil national
    
    document.addEventListener('DOMContentLoaded', function() {
      // Vérifier si deuil national activé via config ou URL
      const urlParams = new URLSearchParams(window.location.search);
      const deuilParam = urlParams.get('deuil');
      
      if (DEUIL_NATIONAL || deuilParam === '1' || deuilParam === 'true') {
        document.documentElement.setAttribute('data-fr-mourning', '');
      }
    });
  </script>
</body>
</html>
